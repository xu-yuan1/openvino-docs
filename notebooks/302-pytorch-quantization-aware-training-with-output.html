
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Quantization Aware Training with NNCF, using PyTorch framework &#8212; OpenVINO™  documentation</title>
    
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../_static/doxyrest-pygments.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <link href="../_static/css/media/favicon.ico" rel="shortcut icon">
    <link rel="stylesheet" href="../_static/css/openvino_sphinx_theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/button.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/input.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/textfield.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/tabs.css" type="text/css" />
    <script src="../_static/js/openvino_sphinx_theme.js"></script>
    <link rel="stylesheet" href="../_static/css/viewer.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/0.5.7/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-barchart-background@1.3.0/build/Plugin.Barchart.Background.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-deferred@1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>
    <script src="../_static/js/viewer.min.js"></script>
    <script src="/assets/versions_raw.js"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/tabs.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/custom.js"></script>
    <script src="../_static/js/graphs.js"></script>
    <script src="../_static/js/graphs_ov_tf.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/target-highlight.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <link rel="canonical" href="https://docs.openvino.ai/latest/notebooks/302-pytorch-quantization-aware-training-with-output.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Quantization Aware Training with NNCF, using TensorFlow Framework" href="305-tensorflow-quantization-aware-training-with-output.html" />
    <link rel="prev" title="Post-Training Quantization with TensorFlow Classification Model" href="301-tensorflow-training-openvino-pot-with-output.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
      <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/logo.svg" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../pages/get_started.html">
  Get Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../pages/documentation.html">
  Documentation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../tutorials.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/api_reference.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../model_zoo.html">
  Model Zoo
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../pages/resources.html">
  Resources
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/openvinotoolkit/openvino" rel="noopener" target="_blank" title="GitHub">
            <span><i class="sst-github"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
</ul>
      </div>
      
      <div class="navbar-end-item">
        
<div class="dropdown sst-dropdown sst-dropdown-navbar">
  <button class="btn sst-btn dropdown-toggle" type="button" id="version-selector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
  <div class="dropdown-menu" aria-labelledby="version-selector">
  </div>
</div>
      </div>
      
      <div class="navbar-end-item">
        

<div class="dropdown sst-dropdown sst-dropdown-navbar">
  <button class="btn sst-btn dropdown-toggle" type="button" id="language-selector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">English</button>
  <div class="dropdown-menu" aria-labelledby="language-selector">
    
      
        <a class="dropdown-item font-weight-bold" href="/latest/notebooks/302-pytorch-quantization-aware-training-with-output.html">English</a>
      
    
      
        <a  class="dropdown-item" href="/cn/latest/notebooks/302-pytorch-quantization-aware-training-with-output.html">Chinese</a>
      
    
  </div>
</div>

      </div>
      
    </div>
  </div>
</div>
        <div id="collapse-nav-wrapper" class="container-xl">
          <button id="collapse-nav" class="button bttn-prm button-size-m" type="button" data-toggle="collapse" data-target="#nav-tree" aria-expanded="false" aria-controls="nav-tree">
            Documentation navigation <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </nav>
      <div class="transition-banner container-fluid alert alert-info alert-dismissible fade show" role="alert">
        <p>OpenVINO 2022.1 introduces a new version of OpenVINO API (API 2.0). For more information on the changes and transition steps, see the <a href="https://docs.openvino.ai/latest/openvino_2_0_transition_guide.html">transition guide</a></p>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
    </div>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar" id="nav-tree"><form class="searchForm bd-search d-flex align-items-center" action="../search.html" method="get">
    <i class="icon fas fa-search"></i>
    <input type="search" class="form-control" name="query" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="001-hello-world-with-output.html">
   Hello Image Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="002-openvino-api-with-output.html">
   OpenVINO API Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="003-hello-segmentation-with-output.html">
   Hello Image Segmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="004-hello-detection-with-output.html">
   Hello Object Detection
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="101-tensorflow-to-openvino-with-output.html">
   Convert a TensorFlow Model to OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="102-pytorch-onnx-to-openvino-with-output.html">
   Convert a PyTorch Model to ONNX and OpenVINO IR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="103-paddle-onnx-to-openvino-classification-with-output.html">
   Convert a PaddlePaddle Model to ONNX and OpenVINO IR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="104-model-tools-with-output.html">
   Working with Open Model Zoo Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="105-language-quantize-bert-with-output.html">
   Quantize NLP models with OpenVINO Post-Training Optimization Tool ​
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="106-auto-device-with-output.html">
   Automatic Device Selection with OpenVINO™
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="110-ct-segmentation-quantize-with-output.html">
   Quantize a Segmentation Model and Show Live Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="111-detection-quantization-with-output.html">
   Object Detection Quantization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="112-pytorch-post-training-quantization-nncf-with-output.html">
   Post-Training Quantization of PyTorch models with NNCF
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="113-image-classification-quantization-with-output.html">
   Quantization of Image Classification Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="114-quantization-simplified-mode-with-output.html">
   INT8 Quantization with Post-training Optimization Tool (POT) in Simplified Mode tutorial
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="201-vision-monodepth-with-output.html">
   Monodepth Estimation with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="202-vision-superresolution-image-with-output.html">
   Single Image Super Resolution with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="202-vision-superresolution-video-with-output.html">
   Video Super Resolution with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="205-vision-background-removal-with-output.html">
   Image Background Removal with U^2-Net and OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="206-vision-paddlegan-anime-with-output.html">
   Photos to Anime with PaddleGAN and OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="207-vision-paddlegan-superresolution-with-output.html">
   Super Resolution with PaddleGAN and OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="208-optical-character-recognition-with-output.html">
   Optical Character Recognition (OCR) with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="209-handwritten-ocr-with-output.html">
   Handwritten Chinese and Japanese OCR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="210-ct-scan-live-inference-with-output.html">
   Live Inference and Benchmark CT-scan Data with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="211-speech-to-text-with-output.html">
   Speech to Text with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="212-onnx-style-transfer-with-output.html">
   Style Transfer on ONNX Models with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="213-question-answering-with-output.html">
   Interactive question answering with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="214-vision-paddle-classification-with-output.html">
   PaddlePaddle Image Classification with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="215-image-inpainting-with-output.html">
   Image In-painting with OpenVINO™
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="217-vision-deblur-with-output.html">
   Deblur Photos with DeblurGAN-v2 and OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="218-vehicle-detection-and-recognition-with-output.html">
   Vehicle Detection And Recognition with OpenVINO
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="301-tensorflow-training-openvino-with-output.html">
   From Training to Deployment with TensorFlow and OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="301-tensorflow-training-openvino-pot-with-output.html">
   Post-Training Quantization with TensorFlow Classification Model
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Quantization Aware Training with NNCF, using PyTorch framework
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="305-tensorflow-quantization-aware-training-with-output.html">
   Quantization Aware Training with NNCF, using TensorFlow Framework
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="401-object-detection-with-output.html">
   Live Object Detection with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="402-pose-estimation-with-output.html">
   Live Human Pose Estimation with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="403-action-recognition-webcam-with-output.html">
   Human Action Recognition with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="405-paddle-ocr-webcam-with-output.html">
   PaddleOCR with OpenVINO
  </a>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports-and-settings">
   Imports and Settings
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pre-train-floating-point-model">
   Pre-train Floating-Point Model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-function">
     Train Function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validate-function">
     Validate Function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#helpers">
     Helpers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-a-pre-trained-fp32-model">
     Get a Pre-trained FP32 Model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-and-initialize-quantization">
   Create and Initialize Quantization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fine-tune-the-compressed-model">
   Fine-tune the Compressed Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#export-int8-model-to-onnx">
   Export INT8 Model to ONNX
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convert-onnx-models-to-openvino-intermediate-representation-ir">
   Convert ONNX models to OpenVINO Intermediate Representation (IR)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#benchmark-model-performance-by-computing-inference-time">
   Benchmark Model Performance by Computing Inference Time
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                <div class="tocsection download-docs">
  <div class="dropdown sst-dropdown">
    <button class="button bttn-prm button-size-m" data-display="static" type="button" id="download-options"
      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      Download Docs
    </button>
    <div class="dropdown-menu" aria-labelledby="download-options">
      <a class="dropdown-item" href="#" onclick="window.print()">.pdf</a>
      <a id="download-zip-btn" class="dropdown-item" href="#">.zip</a>
    </div>
  </div>
</div>
              </div>
              
            
          </div>
          

          
          
              
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">

<div class="tocsection editthispage">
    <a href="None">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

            
                <div>
                  
  <section id="quantization-aware-training-with-nncf-using-pytorch-framework">
<h1>Quantization Aware Training with NNCF, using PyTorch framework<a class="headerlink" href="#quantization-aware-training-with-nncf-using-pytorch-framework" title="Permalink to this headline">¶</a></h1>
<p>This notebook is based on <a class="reference external" href="https://github.com/pytorch/examples/blob/master/imagenet/main.py">ImageNet training in
PyTorch</a>.</p>
<p>The goal of this notebook is to demonstrate how to use the Neural
Network Compression Framework
<a class="reference external" href="https://github.com/openvinotoolkit/nncf">NNCF</a> 8-bit quantization to
optimize a PyTorch model for inference with OpenVINO Toolkit. The
optimization process contains the following steps:</p>
<ul class="simple">
<li><p>Transform the original FP32 model to INT8</p></li>
<li><p>Use fine-tuning to restore the accuracy</p></li>
<li><p>Export optimized and original models to ONNX and then to OpenVINO IR</p></li>
<li><p>Measure and compare the performance of models</p></li>
</ul>
<p>For more advanced usage, please refer to these
<a class="reference external" href="https://github.com/openvinotoolkit/nncf/tree/develop/examples">examples</a>.</p>
<p>We selected the ResNet-18 model with the Tiny ImageNet-200 dataset.
ResNet-18 is the version of ResNet models that contains the fewest
layers (18). Tiny ImageNet-200 is a subset of the larger ImageNet
dataset with smaller images. The dataset will be downloaded in the
notebook. Using the smaller model and dataset will speed up training and
download time. To see other ResNet models, visit <a class="reference external" href="https://pytorch.org/hub/pytorch_vision_resnet/">PyTorch
hub</a>.</p>
<blockquote>
<div><p>NOTE: <em>This notebook requires a C++ compiler.</em></p>
</div></blockquote>
<section id="imports-and-settings">
<h2>Imports and Settings<a class="headerlink" href="#imports-and-settings" title="Permalink to this headline">¶</a></h2>
<p>On Windows, add the required C++ directories to the system’s path.</p>
<p>Import NNCF and all auxiliary packages from your Python code. Set a name
for the model, and the image width and height that will be used for the
network. Also define paths where PyTorch, ONNX and OpenVINO IR versions
of the models will be stored.</p>
<blockquote>
<div><p>NOTE: All NNCF logging messages below ERROR level (INFO and WARNING)
are disabled to simplify the tutorial. For production use, it is
recommended to enable logging, by removing
<code class="docutils literal notranslate"><span class="pre">set_log_level(logging.ERROR)</span></code>.</p>
</div></blockquote>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># On Windows, add the directory that contains cl.exe to the PATH to enable PyTorch to find the</span>
<span class="c1"># required C++ tools. This code assumes that Visual Studio 2019 is installed in the default</span>
<span class="c1"># directory. If you have a different C++ compiler, please add the correct path to os.environ[&quot;PATH&quot;]</span>
<span class="c1"># directly. Note that the C++ Redistributable is not enough to run this notebook.</span>

<span class="c1"># Adding the path to os.environ[&quot;LIB&quot;] is not always required - it depends on the system&#39;s configuration</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">distutils.command.build_ext</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

    <span class="n">VS_INSTALL_DIR</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:/Program Files (x86)/Microsoft Visual Studio&quot;</span>
    <span class="n">cl_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">VS_INSTALL_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/Hostx86/x64/cl.exe&quot;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot find Visual Studio. This notebook requires a C++ compiler. If you installed &quot;</span>
            <span class="s2">&quot;a C++ compiler, please add the directory that contains cl.exe to `os.environ[&#39;PATH&#39;]`.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If multiple versions of MSVC are installed, get the most recent version</span>
        <span class="n">cl_path</span> <span class="o">=</span> <span class="n">cl_paths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vs_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cl_path</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="si">}{</span><span class="n">vs_dir</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># Code for finding the library dirs from</span>
        <span class="c1"># https://stackoverflow.com/questions/47423246/get-pythons-lib-path</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">distutils</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Distribution</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">distutils</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">build_ext</span><span class="o">.</span><span class="n">build_ext</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">finalize_options</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LIB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">library_dirs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">vs_dir</span><span class="si">}</span><span class="s2"> to PATH&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>  <span class="c1"># to disable warnings on export to ONNX</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">nncf</span>  <span class="c1"># Important - should be imported directly after torch</span>

<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.parallel</span>
<span class="kn">import</span> <span class="nn">torch.optim</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span>
<span class="kn">import</span> <span class="nn">torch.utils.data.distributed</span>
<span class="kn">import</span> <span class="nn">torchvision.datasets</span> <span class="k">as</span> <span class="nn">datasets</span>
<span class="kn">import</span> <span class="nn">torchvision.models</span> <span class="k">as</span> <span class="nn">models</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>

<span class="kn">from</span> <span class="nn">nncf.common.utils.logger</span> <span class="kn">import</span> <span class="n">set_log_level</span>
<span class="n">set_log_level</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>  <span class="c1"># Disables all NNCF info and warning messages</span>
<span class="kn">from</span> <span class="nn">nncf</span> <span class="kn">import</span> <span class="n">NNCFConfig</span>
<span class="kn">from</span> <span class="nn">nncf.torch</span> <span class="kn">import</span> <span class="n">create_compressed_model</span><span class="p">,</span> <span class="n">register_default_init_args</span>
<span class="kn">from</span> <span class="nn">openvino.runtime</span> <span class="kn">import</span> <span class="n">Core</span>
<span class="kn">from</span> <span class="nn">torch.jit</span> <span class="kn">import</span> <span class="n">TracerWarning</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;../utils&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">notebook_utils</span> <span class="kn">import</span> <span class="n">download_file</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> device&quot;</span><span class="p">)</span>

<span class="n">MODEL_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
<span class="n">BASE_MODEL_NAME</span> <span class="o">=</span> <span class="s2">&quot;resnet18&quot;</span>
<span class="n">image_size</span> <span class="o">=</span> <span class="mi">64</span>

<span class="n">OUTPUT_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">MODEL_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">DATA_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Paths where PyTorch, ONNX and OpenVINO IR models will be stored</span>
<span class="n">fp32_pth_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">MODEL_DIR</span> <span class="o">/</span> <span class="p">(</span><span class="n">BASE_MODEL_NAME</span> <span class="o">+</span> <span class="s2">&quot;_fp32&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pth&quot;</span><span class="p">)</span>
<span class="n">fp32_onnx_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">OUTPUT_DIR</span> <span class="o">/</span> <span class="p">(</span><span class="n">BASE_MODEL_NAME</span> <span class="o">+</span> <span class="s2">&quot;_fp32&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.onnx&quot;</span><span class="p">)</span>
<span class="n">fp32_ir_path</span> <span class="o">=</span> <span class="n">fp32_onnx_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">)</span>
<span class="n">int8_onnx_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">OUTPUT_DIR</span> <span class="o">/</span> <span class="p">(</span><span class="n">BASE_MODEL_NAME</span> <span class="o">+</span> <span class="s2">&quot;_int8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.onnx&quot;</span><span class="p">)</span>
<span class="n">int8_ir_path</span> <span class="o">=</span> <span class="n">int8_onnx_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">)</span>

<span class="c1"># It&#39;s possible to train FP32 model from scratch, but it might be slow. So the pre-trained weights are downloaded by default.</span>
<span class="n">pretrained_on_tiny_imagenet</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">fp32_pth_url</span> <span class="o">=</span> <span class="s2">&quot;https://storage.openvinotoolkit.org/repositories/nncf/openvino_notebook_ckpts/302_resnet18_fp32_v1.pth&quot;</span>
<span class="n">download_file</span><span class="p">(</span><span class="n">fp32_pth_url</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">MODEL_DIR</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">fp32_pth_path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">nncf</span><span class="o">/</span><span class="n">torch</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">NNCF</span> <span class="n">provides</span> <span class="n">best</span> <span class="n">results</span> <span class="k">with</span> <span class="n">torch</span><span class="o">==</span><span class="mf">1.9.1</span><span class="p">,</span> <span class="k">while</span> <span class="n">current</span> <span class="n">torch</span> <span class="n">version</span> <span class="ow">is</span> <span class="mf">1.7.1</span><span class="o">+</span><span class="n">cpu</span> <span class="o">-</span> <span class="n">consider</span> <span class="n">switching</span> <span class="n">to</span> <span class="n">torch</span><span class="o">==</span><span class="mf">1.9.1</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;NNCF provides best results with torch==</span><span class="si">{bkc}</span><span class="s2">, &quot;</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">nncf</span><span class="o">/</span><span class="n">torch</span><span class="o">/</span><span class="n">dynamic_graph</span><span class="o">/</span><span class="n">patch_pytorch</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">163</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">Not</span> <span class="n">patching</span> <span class="n">unique_dim</span> <span class="n">since</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">missing</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">version</span> <span class="n">of</span> <span class="n">PyTorch</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Not patching </span><span class="si">{}</span><span class="s2"> since it is missing in this version of PyTorch&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op_name</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Using</span> <span class="n">cpu</span> <span class="n">device</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>model/resnet18_fp32.pth:   0%|          | 0.00/43.1M [00:00&lt;?, ?B/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/home/runner/work/openvino_notebooks/openvino_notebooks/notebooks/302-pytorch-quantization-aware-training/model/resnet18_fp32.pth&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Download Tiny ImageNet dataset * 100k images of shape 3x64x64 * 200
different classes: snake, spider, cat, truck, grasshopper, gull, etc.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">download_tiny_imagenet_200</span><span class="p">(</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://cs231n.stanford.edu/tiny-imagenet-200.zip&quot;</span><span class="p">,</span>
    <span class="n">tarname</span><span class="o">=</span><span class="s2">&quot;tiny-imagenet-200.zip&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">archive_path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="n">tarname</span>
    <span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">tarname</span><span class="p">)</span>
    <span class="n">zip_ref</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">archive_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="n">zip_ref</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">prepare_tiny_imagenet_200</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
    <span class="c1"># format validation set the same way as train set is formatted</span>
    <span class="n">val_data_dir</span> <span class="o">=</span> <span class="n">dataset_dir</span> <span class="o">/</span> <span class="s1">&#39;val&#39;</span>
    <span class="n">val_annotations_file</span> <span class="o">=</span> <span class="n">val_data_dir</span> <span class="o">/</span> <span class="s1">&#39;val_annotations.txt&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">val_annotations_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">val_annotation_data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
    <span class="n">val_images_dir</span> <span class="o">=</span> <span class="n">val_data_dir</span> <span class="o">/</span> <span class="s1">&#39;images&#39;</span>
    <span class="k">for</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">image_label</span> <span class="ow">in</span> <span class="n">val_annotation_data</span><span class="p">:</span>
        <span class="n">from_image_filepath</span> <span class="o">=</span> <span class="n">val_images_dir</span> <span class="o">/</span> <span class="n">image_filename</span>
        <span class="n">to_image_dir</span> <span class="o">=</span> <span class="n">val_data_dir</span> <span class="o">/</span> <span class="n">image_label</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_image_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">to_image_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="n">to_image_filepath</span> <span class="o">=</span> <span class="n">to_image_dir</span> <span class="o">/</span> <span class="n">image_filename</span>
        <span class="n">from_image_filepath</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">to_image_filepath</span><span class="p">)</span>
    <span class="n">val_annotations_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">val_images_dir</span><span class="o">.</span><span class="n">rmdir</span><span class="p">()</span>


<span class="n">DATASET_DIR</span> <span class="o">=</span> <span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s2">&quot;tiny-imagenet-200&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">DATASET_DIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">download_tiny_imagenet_200</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)</span>
    <span class="n">prepare_tiny_imagenet_200</span><span class="p">(</span><span class="n">DATASET_DIR</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully downloaded and prepared dataset at: </span><span class="si">{</span><span class="n">DATASET_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;data/tiny-imagenet-200.zip&#39;</span> <span class="n">already</span> <span class="n">exists</span><span class="o">.</span>
<span class="n">Successfully</span> <span class="n">downloaded</span> <span class="ow">and</span> <span class="n">prepared</span> <span class="n">dataset</span> <span class="n">at</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">tiny</span><span class="o">-</span><span class="n">imagenet</span><span class="o">-</span><span class="mi">200</span>
</pre></div>
</div>
</section>
<section id="pre-train-floating-point-model">
<h2>Pre-train Floating-Point Model<a class="headerlink" href="#pre-train-floating-point-model" title="Permalink to this headline">¶</a></h2>
<p>Using NNCF for model compression assumes that the user has a pre-trained
model and a training pipeline.</p>
<p>Here we demonstrate one possible training pipeline: a ResNet-18 model
pre-trained on 1000 classes from ImageNet is fine-tuned with 200 classes
from Tiny-Imagenet.</p>
<p>Subsequently, the training and validation functions will be reused as is
for quantization-aware training.</p>
<section id="train-function">
<h3>Train Function<a class="headerlink" href="#train-function" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
    <span class="n">batch_time</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">,</span> <span class="s2">&quot;:3.3f&quot;</span><span class="p">)</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">,</span> <span class="s2">&quot;:2.3f&quot;</span><span class="p">)</span>
    <span class="n">top1</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">(</span><span class="s2">&quot;Acc@1&quot;</span><span class="p">,</span> <span class="s2">&quot;:2.2f&quot;</span><span class="p">)</span>
    <span class="n">top5</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">(</span><span class="s2">&quot;Acc@5&quot;</span><span class="p">,</span> <span class="s2">&quot;:2.2f&quot;</span><span class="p">)</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressMeter</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">),</span> <span class="p">[</span><span class="n">batch_time</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">top1</span><span class="p">,</span> <span class="n">top5</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Epoch:[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># switch to train mode</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># compute output</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># measure accuracy and record loss</span>
        <span class="n">acc1</span><span class="p">,</span> <span class="n">acc5</span> <span class="o">=</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">top1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">top5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># compute gradient and do opt step</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># measure elapsed time</span>
        <span class="n">batch_time</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">end</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">print_frequency</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">print_frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="validate-function">
<h3>Validate Function<a class="headerlink" href="#validate-function" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">val_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">):</span>
    <span class="n">batch_time</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">,</span> <span class="s2">&quot;:3.3f&quot;</span><span class="p">)</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">,</span> <span class="s2">&quot;:2.3f&quot;</span><span class="p">)</span>
    <span class="n">top1</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">(</span><span class="s2">&quot;Acc@1&quot;</span><span class="p">,</span> <span class="s2">&quot;:2.2f&quot;</span><span class="p">)</span>
    <span class="n">top5</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">(</span><span class="s2">&quot;Acc@5&quot;</span><span class="p">,</span> <span class="s2">&quot;:2.2f&quot;</span><span class="p">)</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressMeter</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">),</span> <span class="p">[</span><span class="n">batch_time</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">top1</span><span class="p">,</span> <span class="n">top5</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Test: &quot;</span><span class="p">)</span>

    <span class="c1"># switch to evaluate mode</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val_loader</span><span class="p">):</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># compute output</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="c1"># measure accuracy and record loss</span>
            <span class="n">acc1</span><span class="p">,</span> <span class="n">acc5</span> <span class="o">=</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">top1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">top5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

            <span class="c1"># measure elapsed time</span>
            <span class="n">batch_time</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">print_frequency</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">print_frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; * Acc@1 </span><span class="si">{top1.avg:.3f}</span><span class="s2"> Acc@5 </span><span class="si">{top5.avg:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top1</span><span class="o">=</span><span class="n">top1</span><span class="p">,</span> <span class="n">top5</span><span class="o">=</span><span class="n">top5</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">top1</span><span class="o">.</span><span class="n">avg</span>
</pre></div>
</div>
</section>
<section id="helpers">
<h3>Helpers<a class="headerlink" href="#helpers" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AverageMeter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes and stores the average and current value&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;:f&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fmtstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2"> {val&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">+</span> <span class="s2">&quot;} ({avg&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">+</span> <span class="s2">&quot;})&quot;</span>
        <span class="k">return</span> <span class="n">fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ProgressMeter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_batches</span><span class="p">,</span> <span class="n">meters</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_fmtstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_batch_fmtstr</span><span class="p">(</span><span class="n">num_batches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meters</span> <span class="o">=</span> <span class="n">meters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>

    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">batch</span><span class="p">)]</span>
        <span class="n">entries</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">meter</span><span class="p">)</span> <span class="k">for</span> <span class="n">meter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meters</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">entries</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_batch_fmtstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_batches</span><span class="p">):</span>
        <span class="n">num_digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num_batches</span> <span class="o">//</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;{:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_digits</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;d}&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_batches</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>


<span class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)):</span>
    <span class="sd">&quot;&quot;&quot;Computes the accuracy over the k top predictions for the specified values of k&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">maxk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">topk</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">maxk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">topk</span><span class="p">:</span>
            <span class="n">correct_k</span> <span class="o">=</span> <span class="n">correct</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correct_k</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="mf">100.0</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</section>
<section id="get-a-pre-trained-fp32-model">
<h3>Get a Pre-trained FP32 Model<a class="headerlink" href="#get-a-pre-trained-fp32-model" title="Permalink to this headline">¶</a></h3>
<p>А pre-trained floating-point model is a prerequisite for quantization.
It can be obtained by tuning from scratch with the code below. However,
this usually takes a lot of time. Therefore, we have already run this
code and received good enough weights after 4 epochs (for the sake of
simplicity, we did not tune until the best accuracy). By default, this
notebook just loads these weights without launching training. To train
the model yourself on a model pre-trained on ImageNet, set
<code class="docutils literal notranslate"><span class="pre">pretrained_on_tiny_imagenet</span> <span class="pre">=</span> <span class="pre">False</span></code> in the Imports and Settings
section at the top of this notebook.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># 200 is for Tiny ImageNet, default is 1000 for ImageNet</span>
<span class="n">init_lr</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">resnet18</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="ow">not</span> <span class="n">pretrained_on_tiny_imagenet</span><span class="p">)</span>
<span class="c1"># update the last FC layer for Tiny ImageNet number of classes</span>
<span class="n">model</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Data loading code</span>
<span class="n">train_dir</span> <span class="o">=</span> <span class="n">DATASET_DIR</span> <span class="o">/</span> <span class="s2">&quot;train&quot;</span>
<span class="n">val_dir</span> <span class="o">=</span> <span class="n">DATASET_DIR</span> <span class="o">/</span> <span class="s2">&quot;val&quot;</span>
<span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">ImageFolder</span><span class="p">(</span>
    <span class="n">train_dir</span><span class="p">,</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">image_size</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">normalize</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">ImageFolder</span><span class="p">(</span>
    <span class="n">val_dir</span><span class="p">,</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">image_size</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">normalize</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>

<span class="n">val_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># define loss function (criterion) and optimizer</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">init_lr</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">pretrained_on_tiny_imagenet</span><span class="p">:</span>
    <span class="c1">#</span>
    <span class="c1"># ** WARNING: torch.load functionality uses Python&#39;s pickling module that</span>
    <span class="c1"># may be used to perform arbitrary code execution during unpickling. Only load data that you</span>
    <span class="c1"># trust.</span>
    <span class="c1">#</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp32_pth_path</span><span class="p">),</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">acc1_fp32</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;acc1&quot;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">best_acc1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Training loop</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
        <span class="c1"># run a single training epoch</span>
        <span class="n">train</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>

        <span class="c1"># evaluate on validation set</span>
        <span class="n">acc1</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">val_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">)</span>

        <span class="n">is_best</span> <span class="o">=</span> <span class="n">acc1</span> <span class="o">&gt;</span> <span class="n">best_acc1</span>
        <span class="n">best_acc1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">acc1</span><span class="p">,</span> <span class="n">best_acc1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_best</span><span class="p">:</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;state_dict&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;acc1&quot;</span><span class="p">:</span> <span class="n">acc1</span><span class="p">}</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">fp32_pth_path</span><span class="p">)</span>
    <span class="n">acc1_fp32</span> <span class="o">=</span> <span class="n">best_acc1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy of FP32 model: </span><span class="si">{</span><span class="n">acc1_fp32</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Accuracy</span> <span class="n">of</span> <span class="n">FP32</span> <span class="n">model</span><span class="p">:</span> <span class="mf">55.520</span>
</pre></div>
</div>
<p>Export the FP32 model to ONNX, which is supported by OpenVINO™ Toolkit,
to benchmark it in comparison with the INT8 model.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dummy_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dummy_input</span><span class="p">,</span> <span class="n">fp32_onnx_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FP32 ONNX model was exported to </span><span class="si">{</span><span class="n">fp32_onnx_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FP32</span> <span class="n">ONNX</span> <span class="n">model</span> <span class="n">was</span> <span class="n">exported</span> <span class="n">to</span> <span class="n">output</span><span class="o">/</span><span class="n">resnet18_fp32</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span>
</pre></div>
</div>
</section>
</section>
<section id="create-and-initialize-quantization">
<h2>Create and Initialize Quantization<a class="headerlink" href="#create-and-initialize-quantization" title="Permalink to this headline">¶</a></h2>
<p>NNCF enables compression-aware training by integrating into regular
training pipelines. The framework is designed so that modifications to
your original training code are minor. Quantization is the simplest
scenario and requires only 3 modifications.</p>
<ol class="arabic simple">
<li><p>Configure NNCF parameters to specify compression</p></li>
</ol>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nncf_config_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;input_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sample_size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">]},</span>
    <span class="s2">&quot;log_dir&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">),</span>  <span class="c1"># log directory for NNCF-specific logging outputs</span>
    <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;quantization&quot;</span><span class="p">,</span>  <span class="c1"># specify the algorithm here</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="n">nncf_config</span> <span class="o">=</span> <span class="n">NNCFConfig</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">nncf_config_dict</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Provide data loader to initialize the values of quantization ranges
and determine which activation should be signed or unsigned from the
collected statistics using a given number of samples.</p></li>
</ol>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nncf_config</span> <span class="o">=</span> <span class="n">register_default_init_args</span><span class="p">(</span><span class="n">nncf_config</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Create a wrapped model ready for compression fine-tuning from a
pre-trained FP32 model and configuration object.</p></li>
</ol>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compression_ctrl</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">create_compressed_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">nncf_config</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
</pre></div>
</div>
<p>Evaluate the new model on the validation set after initialization of
quantization. The accuracy should be close to the accuracy of the
floating-point FP32 model for a simple case like the one we are
demonstrating now.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acc1</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">val_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy of initialized INT8 model: </span><span class="si">{</span><span class="n">acc1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Test</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.803</span> <span class="p">(</span><span class="mf">0.803</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.003</span> <span class="p">(</span><span class="mf">1.003</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">78.12</span> <span class="p">(</span><span class="mf">78.12</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">89.84</span> <span class="p">(</span><span class="mf">89.84</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.394</span> <span class="p">(</span><span class="mf">0.431</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.900</span> <span class="p">(</span><span class="mf">1.589</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">46.09</span> <span class="p">(</span><span class="mf">61.08</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">82.03</span> <span class="p">(</span><span class="mf">84.52</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.404</span> <span class="p">(</span><span class="mf">0.418</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.712</span> <span class="p">(</span><span class="mf">1.672</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">63.28</span> <span class="p">(</span><span class="mf">59.00</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">79.69</span> <span class="p">(</span><span class="mf">83.18</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">30</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.401</span> <span class="p">(</span><span class="mf">0.412</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">2.285</span> <span class="p">(</span><span class="mf">1.773</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">52.34</span> <span class="p">(</span><span class="mf">57.43</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">68.75</span> <span class="p">(</span><span class="mf">81.50</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">40</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.394</span> <span class="p">(</span><span class="mf">0.410</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.543</span> <span class="p">(</span><span class="mf">1.820</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">64.06</span> <span class="p">(</span><span class="mf">55.98</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">85.94</span> <span class="p">(</span><span class="mf">80.79</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.393</span> <span class="p">(</span><span class="mf">0.407</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">2.002</span> <span class="p">(</span><span class="mf">1.820</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">54.69</span> <span class="p">(</span><span class="mf">55.91</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">75.78</span> <span class="p">(</span><span class="mf">80.58</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">60</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.391</span> <span class="p">(</span><span class="mf">0.406</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.703</span> <span class="p">(</span><span class="mf">1.847</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">57.81</span> <span class="p">(</span><span class="mf">55.37</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">84.38</span> <span class="p">(</span><span class="mf">80.14</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">70</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.347</span> <span class="p">(</span><span class="mf">0.403</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">2.400</span> <span class="p">(</span><span class="mf">1.874</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">46.09</span> <span class="p">(</span><span class="mf">55.00</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">72.66</span> <span class="p">(</span><span class="mf">79.50</span><span class="p">)</span>
 <span class="o">*</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">55.410</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">80.140</span>
<span class="n">Accuracy</span> <span class="n">of</span> <span class="n">initialized</span> <span class="n">INT8</span> <span class="n">model</span><span class="p">:</span> <span class="mf">55.410</span>
</pre></div>
</div>
</section>
<section id="fine-tune-the-compressed-model">
<h2>Fine-tune the Compressed Model<a class="headerlink" href="#fine-tune-the-compressed-model" title="Permalink to this headline">¶</a></h2>
<p>At this step, a regular fine-tuning process is applied to further
improve quantized model accuracy. Normally, several epochs of tuning are
required with a small learning rate, the same that is usually used at
the end of the training of the original model. No other changes in the
training pipeline are required. Here is a simple example.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compression_lr</span> <span class="o">=</span> <span class="n">init_lr</span> <span class="o">/</span> <span class="mi">10</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">compression_lr</span><span class="p">)</span>

<span class="c1"># train for one epoch with NNCF</span>
<span class="n">train</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># evaluate on validation set after Quantization-Aware Training (QAT case)</span>
<span class="n">acc1_int8</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">val_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy of tuned INT8 model: </span><span class="si">{</span><span class="n">acc1_int8</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy drop of tuned INT8 model over pre-trained FP32 model: </span><span class="si">{</span><span class="n">acc1_fp32</span> <span class="o">-</span> <span class="n">acc1_int8</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torchvision</span><span class="o">/</span><span class="n">transforms</span><span class="o">/</span><span class="n">functional_pil</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">FLIP_LEFT_RIGHT</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Pillow</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span><span class="p">)</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Transpose</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span> <span class="n">instead</span><span class="o">.</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span>  <span class="mi">0</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.926</span> <span class="p">(</span><span class="mf">1.926</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.853</span> <span class="p">(</span><span class="mf">0.853</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">79.69</span> <span class="p">(</span><span class="mf">79.69</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">92.19</span> <span class="p">(</span><span class="mf">92.19</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span> <span class="mi">50</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.277</span> <span class="p">(</span><span class="mf">1.340</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.750</span> <span class="p">(</span><span class="mf">0.821</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">85.16</span> <span class="p">(</span><span class="mf">79.52</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">95.31</span> <span class="p">(</span><span class="mf">94.16</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">100</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.355</span> <span class="p">(</span><span class="mf">1.339</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.833</span> <span class="p">(</span><span class="mf">0.810</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">78.12</span> <span class="p">(</span><span class="mf">79.83</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">96.09</span> <span class="p">(</span><span class="mf">94.21</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">150</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.353</span> <span class="p">(</span><span class="mf">1.344</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.729</span> <span class="p">(</span><span class="mf">0.800</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">82.81</span> <span class="p">(</span><span class="mf">80.30</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">96.09</span> <span class="p">(</span><span class="mf">94.23</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">200</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.363</span> <span class="p">(</span><span class="mf">1.347</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.836</span> <span class="p">(</span><span class="mf">0.792</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">75.78</span> <span class="p">(</span><span class="mf">80.53</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">93.75</span> <span class="p">(</span><span class="mf">94.23</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">250</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.342</span> <span class="p">(</span><span class="mf">1.349</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.668</span> <span class="p">(</span><span class="mf">0.785</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">87.50</span> <span class="p">(</span><span class="mf">80.70</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">95.31</span> <span class="p">(</span><span class="mf">94.31</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">300</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.271</span> <span class="p">(</span><span class="mf">1.344</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.804</span> <span class="p">(</span><span class="mf">0.777</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">81.25</span> <span class="p">(</span><span class="mf">80.91</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">94.53</span> <span class="p">(</span><span class="mf">94.44</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">350</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.421</span> <span class="p">(</span><span class="mf">1.344</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.708</span> <span class="p">(</span><span class="mf">0.772</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">83.59</span> <span class="p">(</span><span class="mf">81.03</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">94.53</span> <span class="p">(</span><span class="mf">94.50</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">400</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.354</span> <span class="p">(</span><span class="mf">1.345</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.752</span> <span class="p">(</span><span class="mf">0.766</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">78.12</span> <span class="p">(</span><span class="mf">81.19</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">95.31</span> <span class="p">(</span><span class="mf">94.55</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">450</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.335</span> <span class="p">(</span><span class="mf">1.346</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.773</span> <span class="p">(</span><span class="mf">0.762</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">81.25</span> <span class="p">(</span><span class="mf">81.30</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">93.75</span> <span class="p">(</span><span class="mf">94.63</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">500</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.354</span> <span class="p">(</span><span class="mf">1.346</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.912</span> <span class="p">(</span><span class="mf">0.758</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">77.34</span> <span class="p">(</span><span class="mf">81.38</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">92.19</span> <span class="p">(</span><span class="mf">94.67</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">550</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.351</span> <span class="p">(</span><span class="mf">1.347</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.779</span> <span class="p">(</span><span class="mf">0.756</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">84.38</span> <span class="p">(</span><span class="mf">81.42</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">93.75</span> <span class="p">(</span><span class="mf">94.65</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">600</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.344</span> <span class="p">(</span><span class="mf">1.347</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.059</span> <span class="p">(</span><span class="mf">0.754</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">75.78</span> <span class="p">(</span><span class="mf">81.54</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">90.62</span> <span class="p">(</span><span class="mf">94.66</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">650</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.336</span> <span class="p">(</span><span class="mf">1.347</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.730</span> <span class="p">(</span><span class="mf">0.750</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">81.25</span> <span class="p">(</span><span class="mf">81.66</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">93.75</span> <span class="p">(</span><span class="mf">94.69</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">700</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.276</span> <span class="p">(</span><span class="mf">1.347</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.728</span> <span class="p">(</span><span class="mf">0.747</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">80.47</span> <span class="p">(</span><span class="mf">81.77</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">94.53</span> <span class="p">(</span><span class="mf">94.70</span><span class="p">)</span>
<span class="n">Epoch</span><span class="p">:[</span><span class="mi">0</span><span class="p">][</span><span class="mi">750</span><span class="o">/</span><span class="mi">782</span><span class="p">]</span>  <span class="n">Time</span> <span class="mf">1.362</span> <span class="p">(</span><span class="mf">1.344</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">0.628</span> <span class="p">(</span><span class="mf">0.745</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">86.72</span> <span class="p">(</span><span class="mf">81.81</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">96.09</span> <span class="p">(</span><span class="mf">94.72</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.886</span> <span class="p">(</span><span class="mf">0.886</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.092</span> <span class="p">(</span><span class="mf">1.092</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">74.22</span> <span class="p">(</span><span class="mf">74.22</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">85.16</span> <span class="p">(</span><span class="mf">85.16</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.408</span> <span class="p">(</span><span class="mf">0.421</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.916</span> <span class="p">(</span><span class="mf">1.501</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">47.66</span> <span class="p">(</span><span class="mf">63.07</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">80.47</span> <span class="p">(</span><span class="mf">84.73</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.369</span> <span class="p">(</span><span class="mf">0.396</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.571</span> <span class="p">(</span><span class="mf">1.575</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">64.84</span> <span class="p">(</span><span class="mf">60.97</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">81.25</span> <span class="p">(</span><span class="mf">84.30</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">30</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.375</span> <span class="p">(</span><span class="mf">0.389</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">2.041</span> <span class="p">(</span><span class="mf">1.685</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">57.81</span> <span class="p">(</span><span class="mf">59.38</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">71.88</span> <span class="p">(</span><span class="mf">82.38</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">40</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.366</span> <span class="p">(</span><span class="mf">0.384</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.540</span> <span class="p">(</span><span class="mf">1.739</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">63.28</span> <span class="p">(</span><span class="mf">58.12</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">85.94</span> <span class="p">(</span><span class="mf">81.67</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.370</span> <span class="p">(</span><span class="mf">0.381</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">2.007</span> <span class="p">(</span><span class="mf">1.746</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">52.34</span> <span class="p">(</span><span class="mf">57.98</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">74.22</span> <span class="p">(</span><span class="mf">81.34</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">60</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.375</span> <span class="p">(</span><span class="mf">0.379</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">1.575</span> <span class="p">(</span><span class="mf">1.779</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">67.19</span> <span class="p">(</span><span class="mf">57.39</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">83.59</span> <span class="p">(</span><span class="mf">80.81</span><span class="p">)</span>
<span class="n">Test</span><span class="p">:</span> <span class="p">[</span><span class="mi">70</span><span class="o">/</span><span class="mi">79</span><span class="p">]</span>   <span class="n">Time</span> <span class="mf">0.329</span> <span class="p">(</span><span class="mf">0.378</span><span class="p">)</span>  <span class="n">Loss</span> <span class="mf">2.373</span> <span class="p">(</span><span class="mf">1.804</span><span class="p">)</span>  <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">46.88</span> <span class="p">(</span><span class="mf">56.95</span><span class="p">)</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">75.00</span> <span class="p">(</span><span class="mf">80.30</span><span class="p">)</span>
 <span class="o">*</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">1</span> <span class="mf">57.400</span> <span class="n">Acc</span><span class="o">@</span><span class="mi">5</span> <span class="mf">80.950</span>
<span class="n">Accuracy</span> <span class="n">of</span> <span class="n">tuned</span> <span class="n">INT8</span> <span class="n">model</span><span class="p">:</span> <span class="mf">57.400</span>
<span class="n">Accuracy</span> <span class="n">drop</span> <span class="n">of</span> <span class="n">tuned</span> <span class="n">INT8</span> <span class="n">model</span> <span class="n">over</span> <span class="n">pre</span><span class="o">-</span><span class="n">trained</span> <span class="n">FP32</span> <span class="n">model</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.880</span>
</pre></div>
</div>
</section>
<section id="export-int8-model-to-onnx">
<h2>Export INT8 Model to ONNX<a class="headerlink" href="#export-int8-model-to-onnx" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">int8_onnx_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">TracerWarning</span><span class="p">)</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
    <span class="c1"># Export INT8 model to ONNX that is supported by the OpenVINO™ toolkit</span>
    <span class="n">compression_ctrl</span><span class="o">.</span><span class="n">export_model</span><span class="p">(</span><span class="n">int8_onnx_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INT8 ONNX model exported to </span><span class="si">{</span><span class="n">int8_onnx_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INT8</span> <span class="n">ONNX</span> <span class="n">model</span> <span class="n">exported</span> <span class="n">to</span> <span class="n">output</span><span class="o">/</span><span class="n">resnet18_int8</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="convert-onnx-models-to-openvino-intermediate-representation-ir">
<h2>Convert ONNX models to OpenVINO Intermediate Representation (IR)<a class="headerlink" href="#convert-onnx-models-to-openvino-intermediate-representation-ir" title="Permalink to this headline">¶</a></h2>
<p>Call the OpenVINO Model Optimizer tool to convert the ONNX model to
OpenVINO IR, with FP16 precision. The models are saved to the current
directory. We add the mean values to the model and scale the output with
the standard deviation by <code class="docutils literal notranslate"><span class="pre">--mean_values</span></code> and <code class="docutils literal notranslate"><span class="pre">--scale_values</span></code>
arguments. It is not necessary to normalize input data before
propagating it through the network with these options.</p>
<p>See the <a class="reference external" href="https://docs.openvino.ai/latest/openvino_docs_MO_DG_Deep_Learning_Model_Optimizer_DevGuide.html">Model Optimizer Developer
Guide</a>
for more information about Model Optimizer.</p>
<p>Executing this command may take a while. There may be some errors or
warnings in the output. Model Optimizer successfully converted the model
to IR if the last lines of the output include:
<code class="docutils literal notranslate"><span class="pre">[</span> <span class="pre">SUCCESS</span> <span class="pre">]</span> <span class="pre">Generated</span> <span class="pre">IR</span> <span class="pre">version</span> <span class="pre">10</span> <span class="pre">model</span></code></p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">fp32_ir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="o">!</span>mo --input_model <span class="nv">$fp32_onnx_path</span> --input_shape <span class="s2">&quot;[1,3, </span><span class="nv">$image_size</span><span class="s2">, </span><span class="nv">$image_size</span><span class="s2">]&quot;</span> --mean_values <span class="s2">&quot;[123.675, 116.28 , 103.53]&quot;</span> --scale_values <span class="s2">&quot;[58.395, 57.12 , 57.375]&quot;</span> --data_type FP16 --output_dir <span class="nv">$OUTPUT_DIR</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span> <span class="n">Optimizer</span> <span class="n">arguments</span><span class="p">:</span>
<span class="n">Common</span> <span class="n">parameters</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Input</span> <span class="n">Model</span><span class="p">:</span>  <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">302</span><span class="o">-</span><span class="n">pytorch</span><span class="o">-</span><span class="n">quantization</span><span class="o">-</span><span class="n">aware</span><span class="o">-</span><span class="n">training</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">resnet18_fp32</span><span class="o">.</span><span class="n">onnx</span>
    <span class="o">-</span> <span class="n">Path</span> <span class="k">for</span> <span class="n">generated</span> <span class="n">IR</span><span class="p">:</span>    <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">302</span><span class="o">-</span><span class="n">pytorch</span><span class="o">-</span><span class="n">quantization</span><span class="o">-</span><span class="n">aware</span><span class="o">-</span><span class="n">training</span><span class="o">/</span><span class="n">output</span>
    <span class="o">-</span> <span class="n">IR</span> <span class="n">output</span> <span class="n">name</span><span class="p">:</span>   <span class="n">resnet18_fp32</span>
    <span class="o">-</span> <span class="n">Log</span> <span class="n">level</span><span class="p">:</span>    <span class="n">ERROR</span>
    <span class="o">-</span> <span class="n">Batch</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">model</span>
    <span class="o">-</span> <span class="n">Input</span> <span class="n">layers</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">model</span>
    <span class="o">-</span> <span class="n">Output</span> <span class="n">layers</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">model</span>
    <span class="o">-</span> <span class="n">Input</span> <span class="n">shapes</span><span class="p">:</span>     <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">Source</span> <span class="n">layout</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Target</span> <span class="n">layout</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Layout</span><span class="p">:</span>   <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Mean</span> <span class="n">values</span><span class="p">:</span>  <span class="p">[</span><span class="mf">123.675</span><span class="p">,</span> <span class="mf">116.28</span> <span class="p">,</span> <span class="mf">103.53</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">Scale</span> <span class="n">values</span><span class="p">:</span>     <span class="p">[</span><span class="mf">58.395</span><span class="p">,</span> <span class="mf">57.12</span> <span class="p">,</span> <span class="mf">57.375</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">Scale</span> <span class="n">factor</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Precision</span> <span class="n">of</span> <span class="n">IR</span><span class="p">:</span>  <span class="n">FP16</span>
    <span class="o">-</span> <span class="n">Enable</span> <span class="n">fusing</span><span class="p">:</span>    <span class="kc">True</span>
    <span class="o">-</span> <span class="n">User</span> <span class="n">transformations</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Reverse</span> <span class="nb">input</span> <span class="n">channels</span><span class="p">:</span>   <span class="kc">False</span>
    <span class="o">-</span> <span class="n">Enable</span> <span class="n">IR</span> <span class="n">generation</span> <span class="k">for</span> <span class="n">fixed</span> <span class="nb">input</span> <span class="n">shape</span><span class="p">:</span>   <span class="kc">False</span>
    <span class="o">-</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">transformations</span> <span class="n">config</span> <span class="n">file</span><span class="p">:</span>  <span class="kc">None</span>
<span class="n">Advanced</span> <span class="n">parameters</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Force</span> <span class="n">the</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">legacy</span> <span class="n">Frontend</span> <span class="n">of</span> <span class="n">Model</span> <span class="n">Optimizer</span> <span class="k">for</span> <span class="n">model</span> <span class="n">conversion</span> <span class="n">into</span> <span class="n">IR</span><span class="p">:</span>   <span class="kc">False</span>
    <span class="o">-</span> <span class="n">Force</span> <span class="n">the</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">new</span> <span class="n">Frontend</span> <span class="n">of</span> <span class="n">Model</span> <span class="n">Optimizer</span> <span class="k">for</span> <span class="n">model</span> <span class="n">conversion</span> <span class="n">into</span> <span class="n">IR</span><span class="p">:</span>  <span class="kc">False</span>
<span class="n">OpenVINO</span> <span class="n">runtime</span> <span class="n">found</span> <span class="ow">in</span><span class="p">:</span>  <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">openvino</span>
<span class="n">OpenVINO</span> <span class="n">runtime</span> <span class="n">version</span><span class="p">:</span>   <span class="mf">2022.1.0</span><span class="o">-</span><span class="mi">7019</span><span class="o">-</span><span class="n">cdb9bec7210</span><span class="o">-</span><span class="n">releases</span><span class="o">/</span><span class="mi">2022</span><span class="o">/</span><span class="mi">1</span>
<span class="n">Model</span> <span class="n">Optimizer</span> <span class="n">version</span><span class="p">:</span>    <span class="mf">2022.1.0</span><span class="o">-</span><span class="mi">7019</span><span class="o">-</span><span class="n">cdb9bec7210</span><span class="o">-</span><span class="n">releases</span><span class="o">/</span><span class="mi">2022</span><span class="o">/</span><span class="mi">1</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">Generated</span> <span class="n">IR</span> <span class="n">version</span> <span class="mi">11</span> <span class="n">model</span><span class="o">.</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">XML</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">302</span><span class="o">-</span><span class="n">pytorch</span><span class="o">-</span><span class="n">quantization</span><span class="o">-</span><span class="n">aware</span><span class="o">-</span><span class="n">training</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">resnet18_fp32</span><span class="o">.</span><span class="n">xml</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">BIN</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">302</span><span class="o">-</span><span class="n">pytorch</span><span class="o">-</span><span class="n">quantization</span><span class="o">-</span><span class="n">aware</span><span class="o">-</span><span class="n">training</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">resnet18_fp32</span><span class="o">.</span><span class="n">bin</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">Total</span> <span class="n">execution</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.78</span> <span class="n">seconds</span><span class="o">.</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">Memory</span> <span class="n">consumed</span><span class="p">:</span> <span class="mi">161</span> <span class="n">MB</span><span class="o">.</span>
<span class="n">It</span><span class="s1">&#39;s been a while, check for a new version of Intel(R) Distribution of OpenVINO(TM) toolkit here https://software.intel.com/content/www/us/en/develop/tools/openvino-toolkit/download.html?cid=other&amp;source=prod&amp;campid=ww_2022_bu_IOTG_OpenVINO-2022-1&amp;content=upg_all&amp;medium=organic or on the GitHub*</span>
<span class="p">[</span> <span class="n">INFO</span> <span class="p">]</span> <span class="n">The</span> <span class="n">model</span> <span class="n">was</span> <span class="n">converted</span> <span class="n">to</span> <span class="n">IR</span> <span class="n">v11</span><span class="p">,</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">model</span> <span class="nb">format</span> <span class="n">that</span> <span class="n">corresponds</span> <span class="n">to</span> <span class="n">the</span> <span class="n">source</span> <span class="n">DL</span> <span class="n">framework</span> <span class="nb">input</span><span class="o">/</span><span class="n">output</span> <span class="nb">format</span><span class="o">.</span> <span class="n">While</span> <span class="n">IR</span> <span class="n">v11</span> <span class="ow">is</span> <span class="n">backwards</span> <span class="n">compatible</span> <span class="k">with</span> <span class="n">OpenVINO</span> <span class="n">Inference</span> <span class="n">Engine</span> <span class="n">API</span> <span class="n">v1</span><span class="mf">.0</span><span class="p">,</span> <span class="n">please</span> <span class="n">use</span> <span class="n">API</span> <span class="n">v2</span><span class="mf">.0</span> <span class="p">(</span><span class="k">as</span> <span class="n">of</span> <span class="mf">2022.1</span><span class="p">)</span> <span class="n">to</span> <span class="n">take</span> <span class="n">advantage</span> <span class="n">of</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">improvements</span> <span class="ow">in</span> <span class="n">IR</span> <span class="n">v11</span><span class="o">.</span>
<span class="n">Find</span> <span class="n">more</span> <span class="n">information</span> <span class="n">about</span> <span class="n">API</span> <span class="n">v2</span><span class="mf">.0</span> <span class="ow">and</span> <span class="n">IR</span> <span class="n">v11</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="o">.</span><span class="n">openvino</span><span class="o">.</span><span class="n">ai</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">int8_ir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="o">!</span>mo --input_model <span class="nv">$int8_onnx_path</span> --input_shape <span class="s2">&quot;[1,3, </span><span class="nv">$image_size</span><span class="s2">, </span><span class="nv">$image_size</span><span class="s2">]&quot;</span> --mean_values <span class="s2">&quot;[123.675, 116.28 , 103.53]&quot;</span> --scale_values <span class="s2">&quot;[58.395, 57.12 , 57.375]&quot;</span> --data_type FP16 --output_dir <span class="nv">$OUTPUT_DIR</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span> <span class="n">Optimizer</span> <span class="n">arguments</span><span class="p">:</span>
<span class="n">Common</span> <span class="n">parameters</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Input</span> <span class="n">Model</span><span class="p">:</span>  <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">302</span><span class="o">-</span><span class="n">pytorch</span><span class="o">-</span><span class="n">quantization</span><span class="o">-</span><span class="n">aware</span><span class="o">-</span><span class="n">training</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">resnet18_int8</span><span class="o">.</span><span class="n">onnx</span>
    <span class="o">-</span> <span class="n">Path</span> <span class="k">for</span> <span class="n">generated</span> <span class="n">IR</span><span class="p">:</span>    <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">302</span><span class="o">-</span><span class="n">pytorch</span><span class="o">-</span><span class="n">quantization</span><span class="o">-</span><span class="n">aware</span><span class="o">-</span><span class="n">training</span><span class="o">/</span><span class="n">output</span>
    <span class="o">-</span> <span class="n">IR</span> <span class="n">output</span> <span class="n">name</span><span class="p">:</span>   <span class="n">resnet18_int8</span>
    <span class="o">-</span> <span class="n">Log</span> <span class="n">level</span><span class="p">:</span>    <span class="n">ERROR</span>
    <span class="o">-</span> <span class="n">Batch</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">model</span>
    <span class="o">-</span> <span class="n">Input</span> <span class="n">layers</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">model</span>
    <span class="o">-</span> <span class="n">Output</span> <span class="n">layers</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">model</span>
    <span class="o">-</span> <span class="n">Input</span> <span class="n">shapes</span><span class="p">:</span>     <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">Source</span> <span class="n">layout</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Target</span> <span class="n">layout</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Layout</span><span class="p">:</span>   <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Mean</span> <span class="n">values</span><span class="p">:</span>  <span class="p">[</span><span class="mf">123.675</span><span class="p">,</span> <span class="mf">116.28</span> <span class="p">,</span> <span class="mf">103.53</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">Scale</span> <span class="n">values</span><span class="p">:</span>     <span class="p">[</span><span class="mf">58.395</span><span class="p">,</span> <span class="mf">57.12</span> <span class="p">,</span> <span class="mf">57.375</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">Scale</span> <span class="n">factor</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Precision</span> <span class="n">of</span> <span class="n">IR</span><span class="p">:</span>  <span class="n">FP16</span>
    <span class="o">-</span> <span class="n">Enable</span> <span class="n">fusing</span><span class="p">:</span>    <span class="kc">True</span>
    <span class="o">-</span> <span class="n">User</span> <span class="n">transformations</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Reverse</span> <span class="nb">input</span> <span class="n">channels</span><span class="p">:</span>   <span class="kc">False</span>
    <span class="o">-</span> <span class="n">Enable</span> <span class="n">IR</span> <span class="n">generation</span> <span class="k">for</span> <span class="n">fixed</span> <span class="nb">input</span> <span class="n">shape</span><span class="p">:</span>   <span class="kc">False</span>
    <span class="o">-</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">transformations</span> <span class="n">config</span> <span class="n">file</span><span class="p">:</span>  <span class="kc">None</span>
<span class="n">Advanced</span> <span class="n">parameters</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Force</span> <span class="n">the</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">legacy</span> <span class="n">Frontend</span> <span class="n">of</span> <span class="n">Model</span> <span class="n">Optimizer</span> <span class="k">for</span> <span class="n">model</span> <span class="n">conversion</span> <span class="n">into</span> <span class="n">IR</span><span class="p">:</span>   <span class="kc">False</span>
    <span class="o">-</span> <span class="n">Force</span> <span class="n">the</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">new</span> <span class="n">Frontend</span> <span class="n">of</span> <span class="n">Model</span> <span class="n">Optimizer</span> <span class="k">for</span> <span class="n">model</span> <span class="n">conversion</span> <span class="n">into</span> <span class="n">IR</span><span class="p">:</span>  <span class="kc">False</span>
<span class="n">OpenVINO</span> <span class="n">runtime</span> <span class="n">found</span> <span class="ow">in</span><span class="p">:</span>  <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.8.12</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">openvino</span>
<span class="n">OpenVINO</span> <span class="n">runtime</span> <span class="n">version</span><span class="p">:</span>   <span class="mf">2022.1.0</span><span class="o">-</span><span class="mi">7019</span><span class="o">-</span><span class="n">cdb9bec7210</span><span class="o">-</span><span class="n">releases</span><span class="o">/</span><span class="mi">2022</span><span class="o">/</span><span class="mi">1</span>
<span class="n">Model</span> <span class="n">Optimizer</span> <span class="n">version</span><span class="p">:</span>    <span class="mf">2022.1.0</span><span class="o">-</span><span class="mi">7019</span><span class="o">-</span><span class="n">cdb9bec7210</span><span class="o">-</span><span class="n">releases</span><span class="o">/</span><span class="mi">2022</span><span class="o">/</span><span class="mi">1</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">Generated</span> <span class="n">IR</span> <span class="n">version</span> <span class="mi">11</span> <span class="n">model</span><span class="o">.</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">XML</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">302</span><span class="o">-</span><span class="n">pytorch</span><span class="o">-</span><span class="n">quantization</span><span class="o">-</span><span class="n">aware</span><span class="o">-</span><span class="n">training</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">resnet18_int8</span><span class="o">.</span><span class="n">xml</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">BIN</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">openvino_notebooks</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">302</span><span class="o">-</span><span class="n">pytorch</span><span class="o">-</span><span class="n">quantization</span><span class="o">-</span><span class="n">aware</span><span class="o">-</span><span class="n">training</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">resnet18_int8</span><span class="o">.</span><span class="n">bin</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">Total</span> <span class="n">execution</span> <span class="n">time</span><span class="p">:</span> <span class="mf">1.29</span> <span class="n">seconds</span><span class="o">.</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">Memory</span> <span class="n">consumed</span><span class="p">:</span> <span class="mi">167</span> <span class="n">MB</span><span class="o">.</span>
<span class="n">It</span><span class="s1">&#39;s been a while, check for a new version of Intel(R) Distribution of OpenVINO(TM) toolkit here https://software.intel.com/content/www/us/en/develop/tools/openvino-toolkit/download.html?cid=other&amp;source=prod&amp;campid=ww_2022_bu_IOTG_OpenVINO-2022-1&amp;content=upg_all&amp;medium=organic or on the GitHub*</span>
<span class="p">[</span> <span class="n">INFO</span> <span class="p">]</span> <span class="n">The</span> <span class="n">model</span> <span class="n">was</span> <span class="n">converted</span> <span class="n">to</span> <span class="n">IR</span> <span class="n">v11</span><span class="p">,</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">model</span> <span class="nb">format</span> <span class="n">that</span> <span class="n">corresponds</span> <span class="n">to</span> <span class="n">the</span> <span class="n">source</span> <span class="n">DL</span> <span class="n">framework</span> <span class="nb">input</span><span class="o">/</span><span class="n">output</span> <span class="nb">format</span><span class="o">.</span> <span class="n">While</span> <span class="n">IR</span> <span class="n">v11</span> <span class="ow">is</span> <span class="n">backwards</span> <span class="n">compatible</span> <span class="k">with</span> <span class="n">OpenVINO</span> <span class="n">Inference</span> <span class="n">Engine</span> <span class="n">API</span> <span class="n">v1</span><span class="mf">.0</span><span class="p">,</span> <span class="n">please</span> <span class="n">use</span> <span class="n">API</span> <span class="n">v2</span><span class="mf">.0</span> <span class="p">(</span><span class="k">as</span> <span class="n">of</span> <span class="mf">2022.1</span><span class="p">)</span> <span class="n">to</span> <span class="n">take</span> <span class="n">advantage</span> <span class="n">of</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">improvements</span> <span class="ow">in</span> <span class="n">IR</span> <span class="n">v11</span><span class="o">.</span>
<span class="n">Find</span> <span class="n">more</span> <span class="n">information</span> <span class="n">about</span> <span class="n">API</span> <span class="n">v2</span><span class="mf">.0</span> <span class="ow">and</span> <span class="n">IR</span> <span class="n">v11</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="o">.</span><span class="n">openvino</span><span class="o">.</span><span class="n">ai</span>
</pre></div>
</div>
</section>
<section id="benchmark-model-performance-by-computing-inference-time">
<h2>Benchmark Model Performance by Computing Inference Time<a class="headerlink" href="#benchmark-model-performance-by-computing-inference-time" title="Permalink to this headline">¶</a></h2>
<p>Finally, we will measure the inference performance of the FP32 and INT8
models. To do this, we use <a class="reference external" href="https://docs.openvino.ai/latest/openvino_inference_engine_tools_benchmark_tool_README.html">Benchmark
Tool</a>
- OpenVINO’s inference performance measurement tool. By default,
Benchmark Tool runs inference for 60 seconds in asynchronous mode on
CPU. It returns inference speed as latency (milliseconds per image) and
throughput (frames per second) values.</p>
<blockquote>
<div><p><strong>NOTE</strong>: In this notebook we run benchmark_app for 15 seconds to
give a quick indication of performance. For more accurate
performance, we recommended running benchmark_app in a
terminal/command prompt after closing other applications. Run
<code class="docutils literal notranslate"><span class="pre">benchmark_app</span> <span class="pre">-m</span> <span class="pre">model.xml</span> <span class="pre">-d</span> <span class="pre">CPU</span></code> to benchmark async inference on
CPU for one minute. Change CPU to GPU to benchmark on GPU. Run
<code class="docutils literal notranslate"><span class="pre">benchmark_app</span> <span class="pre">--help</span></code> to see an overview of all command line
options.</p>
</div></blockquote>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_benchmark_output</span><span class="p">(</span><span class="n">benchmark_output</span><span class="p">):</span>
    <span class="n">parsed_output</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">benchmark_output</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span>
    <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">parsed_output</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Benchmark FP32 model (IR)&#39;</span><span class="p">)</span>
<span class="n">benchmark_output</span> <span class="o">=</span> <span class="o">!</span> benchmark_app -m <span class="nv">$fp32_ir_path</span> -d CPU -api async -t <span class="m">15</span>
<span class="n">parse_benchmark_output</span><span class="p">(</span><span class="n">benchmark_output</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Benchmark INT8 model (IR)&#39;</span><span class="p">)</span>
<span class="n">benchmark_output</span> <span class="o">=</span> <span class="o">!</span> benchmark_app -m <span class="nv">$int8_ir_path</span> -d CPU -api async -t <span class="m">15</span>
<span class="n">parse_benchmark_output</span><span class="p">(</span><span class="n">benchmark_output</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Benchmark</span> <span class="n">FP32</span> <span class="n">model</span> <span class="p">(</span><span class="n">IR</span><span class="p">)</span>
<span class="n">Count</span><span class="p">:</span>          <span class="mi">5107</span> <span class="n">iterations</span>
<span class="n">Duration</span><span class="p">:</span>       <span class="mf">15002.97</span> <span class="n">ms</span>
<span class="n">Latency</span><span class="p">:</span>
<span class="n">Throughput</span><span class="p">:</span> <span class="mf">340.40</span> <span class="n">FPS</span>
<span class="n">Benchmark</span> <span class="n">INT8</span> <span class="n">model</span> <span class="p">(</span><span class="n">IR</span><span class="p">)</span>
<span class="n">Count</span><span class="p">:</span>          <span class="mi">16422</span> <span class="n">iterations</span>
<span class="n">Duration</span><span class="p">:</span>       <span class="mf">15001.35</span> <span class="n">ms</span>
<span class="n">Latency</span><span class="p">:</span>
<span class="n">Throughput</span><span class="p">:</span> <span class="mf">1094.70</span> <span class="n">FPS</span>
</pre></div>
</div>
<p>Show CPU Information for reference</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ie</span> <span class="o">=</span> <span class="n">Core</span><span class="p">()</span>
<span class="n">ie</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">device_name</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FULL_DEVICE_NAME&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Intel(R) Xeon(R) Platinum 8272CL CPU @ 2.60GHz&#39;</span>
</pre></div>
</div>
</section>
</section>


                </div>
            
            
                <div class='prev-next-bottom'>
                  
    <a class='button bttn-sec button-size-l' id="prev-link" href="301-tensorflow-training-openvino-pot-with-output.html" title="previous page">Prev</a>
    <a class='button bttn-sec button-size-l' id="next-link" href="305-tensorflow-quantization-aware-training-with-output.html" title="next page">Next</a>

                </div>
            
          </main>
          

      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Intel®.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>